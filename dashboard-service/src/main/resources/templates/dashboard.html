<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Dashboard CRM</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
          rel="stylesheet">
</head>
<body class="bg-light">

<div class="container mt-4">

    <h2 class="mb-4">ðŸ“Š Dashboard CRM</h2>

    <!-- ================= KPI ================= -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card text-center shadow-sm">
                <div class="card-body">
                    <h6>Empresas</h6>
                    <h3 th:text="${totalEmpresas}">0</h3>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card text-center shadow-sm">
                <div class="card-body">
                    <h6>Total Contactos</h6>
                    <h3 th:text="${totalContactos}">0</h3>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card text-center shadow-sm">
                <div class="card-body">
                    <h6>Total Interacciones</h6>
                    <h3 th:text="${totalInteracciones}">0</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- ================= FILTRO EMPRESA ================= -->
    <form method="get" th:action="@{/dashboard}" class="mb-4">
        <div class="row">
            <div class="col-md-4">
                <select name="empresaId" class="form-select"
                        onchange="this.form.submit()">
                    <option value="">-- Todas las empresas --</option>
                    <option th:each="emp : ${empresas}"
                            th:value="${emp.id}"
                            th:text="${emp.nombre}"
                            th:selected="${emp.id == empresaSeleccionada}">
                    </option>
                </select>
            </div>
        </div>
    </form>

    <!-- ================= CREAR EMPRESA ================= -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-primary text-white">
            Nueva Empresa
        </div>
        <div class="card-body">
            <form th:action="@{/dashboard/empresa}" method="post"
                  th:object="${empresaForm}">
                <div class="row">
                    <div class="col-md-3">
                        <input type="text" th:field="*{nombre}"
                               placeholder="Nombre"
                               class="form-control" required>
                    </div>
                    <div class="col-md-2">
                        <input type="text" th:field="*{nit}"
                               placeholder="NIT"
                               class="form-control">
                    </div>
                    <div class="col-md-3">
                        <input type="text" th:field="*{direccion}"
                               placeholder="DirecciÃ³n"
                               class="form-control">
                    </div>
                    <div class="col-md-2">
                        <input type="text" th:field="*{telefono}"
                               placeholder="TelÃ©fono"
                               class="form-control">
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-success w-100">
                            Crear
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- ================= LISTADO ================= -->
    <div th:each="empresaDash : ${dashboard}">

        <div class="card mb-4 shadow-sm">
            <div class="card-header bg-dark text-white d-flex justify-content-between">
                <div class="d-flex align-items-center">

                    <!-- Icono principal de la empresa -->
                    <i class="bi bi-building me-2 text-primary"></i>

                    <div>
                        <strong th:text="${empresaDash.empresa.nombre}"></strong>

                        <small class="ms-2">

                            |

                            <i class="bi bi-card-text text-secondary"></i>
                            <span th:text="${empresaDash.empresa.nit}"></span>

                            |

                            <i class="bi bi-geo-alt text-danger"></i>
                            <span th:text="${empresaDash.empresa.direccion}"></span>

                            |

                            <i class="bi bi-envelope text-success"></i>
                            <span th:text="${empresaDash.empresa.correoGeneral}"></span>

                        </small>
                    </div>

                </div>

                <!-- Eliminar Empresa -->
                <form th:action="@{'/dashboard/empresa/eliminar/' + ${empresaDash.empresa.id}}"
                      method="post">
                    <button class="btn btn-sm btn-danger">
                        ðŸ—‘
                    </button>
                </form>
            </div>

            <div class="card-body">

                <!-- ===== CREAR CONTACTO ===== -->
                <form th:action="@{/dashboard/contacto}"
                      method="post"
                      th:object="${contactoForm}"
                      class="mb-3">

                    <input type="hidden"
                           th:field="*{empresaId}"
                           th:value="${empresaDash.empresa.id}"/>

                    <div class="row">
                        <div class="col-md-3">
                            <input type="text"
                                   th:field="*{nombre}"
                                   placeholder="Nombre"
                                   class="form-control" required>
                        </div>
                        <div class="col-md-2">
                            <input type="text"
                                   th:field="*{cargo}"
                                   placeholder="Cargo"
                                   class="form-control">
                        </div>
                        <div class="col-md-2">
                            <input type="text"
                                   th:field="*{telefono}"
                                   placeholder="TelÃ©fono"
                                   class="form-control">
                        </div>
                        <div class="col-md-3">
                            <input type="email"
                                   th:field="*{correo}"
                                   placeholder="Correo"
                                   class="form-control">
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-primary w-100">
                                Agregar
                            </button>
                        </div>
                    </div>
                </form>

                <!-- ===== CONTACTOS ===== -->
                <div th:each="contactoDash : ${empresaDash.contactos}"
                     class="border rounded p-3 mb-3 bg-light">

                    <div class="d-flex justify-content-between">
                        <div>
                            <strong th:text="${contactoDash.contacto.nombre}"></strong>
                            -
                            <span th:text="${contactoDash.contacto.cargo}"></span>
                        </div>

                        <!-- Eliminar Contacto -->
                        <form th:action="@{'/dashboard/contacto/eliminar/' + ${contactoDash.contacto.id}}"
                              method="post">
                            <button class="btn btn-sm btn-danger">
                                ðŸ—‘
                            </button>
                        </form>
                    </div>

                    <!-- ===== INTERACCIONES ===== -->
                    <table class="table table-sm mt-2">
                        <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Tipo</th>
                            <th>Resultado</th>
                            <th></th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="inter : ${contactoDash.interacciones}">
                            <td th:text="${inter.fecha}"></td>
                            <td th:text="${inter.tipo}"></td>
                            <td th:text="${inter.resultado}"></td>
                            <td>
                                <form th:action="@{'/dashboard/interaccion/eliminar/' + ${inter.id}}"
                                      method="post">
                                    <button class="btn btn-sm btn-danger">
                                        ðŸ—‘
                                    </button>
                                </form>
                            </td>
                        </tr>
                        </tbody>
                    </table>

                    <!-- Crear InteracciÃ³n -->
                    <form th:action="@{/dashboard/interaccion}"
                          method="post"
                          th:object="${interaccionForm}">

                        <input type="hidden"
                               name="contactoId"
                               th:value="${contactoDash.contacto.id}" />

                        <div class="row">
                            <div class="col-md-3">
                                <input type="datetime-local"
                                       th:field="*{fecha}"
                                       class="form-control" required>
                            </div>
                            <div class="col-md-3">
                                <input type="text"
                                       th:field="*{tipo}"
                                       placeholder="Tipo"
                                       class="form-control">
                            </div>
                            <div class="col-md-4">
                                <input type="text"
                                       th:field="*{resultado}"
                                       placeholder="Resultado"
                                       class="form-control">
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-success w-100">
                                    Registrar
                                </button>
                            </div>
                        </div>
                    </form>

                </div>

            </div>
        </div>

    </div>

</div>

</body>
</html>
